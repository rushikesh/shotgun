<!DOCTYPE html>
<html>
  <head>
    <title>Rushi: Shotgun App</title>

    <script type="text/javascript" charset="utf-8"></script>
    <meta name="viewport" content="height=device-height,width=device-width,initial-scale=1.0,maximum-scale=1.0">
    <script src="cordova.js"></script>
    <style type="text/css">
    .unloaded{
        background: url(img/unloaded.png);
    }
    .loaded{
        background: url(img/loaded.png);
    }
    .readytofire{
        background: url(img/readytofire.png);
    }
    </style>
  </head>
  <body>
    <div id="accel"></div>
    <div><img id="shotGun" src=""/></div>
  </body>
  <script type="text/javascript" charset="utf-8">

    // The watch id references the current `watchAcceleration`
    var watchID = null;
    var prevVal=0;
    var windowWidth;
    var windowHeight;
    var unloaded=true,halfloaded=false,readyToFire=false;
    var img = document.getElementById('shotGun');
    img.src = 'img/unloaded.png';

    // Wait for device API libraries to load
    //
    document.addEventListener("deviceready", onDeviceReady, false);


    // device APIs are available
    //
    function onDeviceReady() {
        windowWidth = $(window).width();
        windowHeight = $(window).height();
        document.getElementById('accel').innerHTML=windowWidth+'--'+windowHeight;
        img.width=windowWidth-50;
        img.height = windowHeight-50;
        startWatch();
    }

    // Start watching the acceleration
    //
    function startWatch() {

        // Update acceleration every 400 milli seconds
        var options = { frequency: 400 };

        watchID = navigator.accelerometer.watchAcceleration(onAccelSuccess, onAccelError, options);
    }

    // Stop watching the acceleration
    //
    function stopWatch() {
        if (watchID) {
            navigator.accelerometer.clearWatch(watchID);
            watchID = null;
        }
    }

    // onSuccess: Get a snapshot of the current acceleration
    //
    function onAccelSuccess(acceleration) {
        var x = +(acceleration.x);x=x.toFixed();
        var y = +(acceleration.y);y=y.toFixed();
        var z = +(acceleration.z);z=z.toFixed();
        var val = Math.sqrt(x*x+y*y+z*z);
        document.getElementById('accel').innerHTML = Math.abs(val-prevVal);
        if(Math.abs(val-prevVal)>1){
            prevVal=val;
            if(unloaded){
                unloaded=false;
                halfloaded = true;
                readyToFire = false;
                playMedia('cocked');
                img.src = 'img/halfcocked.png';
                return;
            }else if(halfloaded){
                unloaded=false;
                halfloaded = false;
                readyToFire = true;
                playMedia('cocked');
                img.src = 'img/readytofire.png';
                return;
            }else if(readyToFire){
                unloaded=true;
                halfloaded = false;
                readyToFire = false;
                playMedia('fire');
                img.src = 'img/unloaded.png';
                return;
            }
        }
                              
    }


    function playMedia(soundEffect){
        var my_media = new Media(getPhoneGapPath()+'audio/'+soundEffect+'.mp3', onAudioSuccess, onAudioError);
        my_media.play();  
    }

    function onAudioSuccess() {
        console.log("playAudio():Audio Success");
    }

    function onAudioError() {
        alert("playAudio():Audio Failure");
    }

    // onError: Failed to get the acceleration
    //
    function onAccelError() {
        alert('Failed to get the acceleration!');
    }

    </script>
</html>